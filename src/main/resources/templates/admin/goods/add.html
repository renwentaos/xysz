<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh">
<head th:replace="fragments/header :: managePublic('添加商品 - 行游神州管理员后台',~{::link})">
    <link href="/js/myPages/myPages.css" rel="stylesheet" type="text/css"/>
    <link href="/js/cropper/cropperjs/cropper.min.css" rel="stylesheet">

</head>
<body>

<div class="modal fade show" id="largeModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content ">
            <div class="loader-wrapper incomponent" id="uploadDiv">
                <div class="spinner">
                    <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                        <circle class="length" fill="none" stroke-width="6" stroke-linecap="round" cx="33"
                                cy="33" r="28"></circle>
                    </svg>
                    <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                        <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33"
                                r="28"></circle>
                    </svg>
                    <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                        <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33"
                                r="28"></circle>
                    </svg>
                    <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                        <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33"
                                r="28"></circle>
                    </svg>
                </div>
            </div>
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">商品图片设置</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span class="material-icons ">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" id="validatedCustomFile" lang="zh">
                        <label class="custom-file-label" for="validatedCustomFile">选择商品图片</label>
                    </div>
                </div>
                <div class="row">
                    <div class="col-8">
                        <img id="imgFile" class="img-thumbnail" style=" width:100%;padding-bottom: 40%;max-width: 100%">
                    </div>
                    <div class="col-4">
                        <div class="text-center ml-2  docs-buttons">
                            <div id="preview" style="width:100px;height:100px;overflow: hidden" class="img-thumbnail">
                            </div>
                            <hr>
                            <div class="btn-group mb-1">
                                <button type="button" class="btn py-1 px-2 btn-primary" data-method="zoom"
                                        data-option="0.1" title="Zoom In">
                                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title=""
                                          data-original-title="放大">
                                      <span class="material-icons align-text-bottom md-18">zoom_in</span>
                                    </span>
                                </button>
                                <button type="button" class="btn py-1 px-2 btn-primary" data-method="zoom"
                                        data-option="-0.1" title="Zoom Out">
                                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title=""
                                          data-original-title="缩小">
                                      <span class="material-icons align-text-bottom md-18">zoom_out</span>
                                    </span>
                                </button>
                            </div>
                            <div class="btn-group mb-1">
                                <button type="button" class="btn py-1 px-2 btn-primary" data-method="rotate"
                                        data-option="-45" title="Rotate Left">
                                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title=""
                                          data-original-title="左旋转45°">
                                      <span class="material-icons align-text-bottom md-18">rotate_left</span>
                                    </span>
                                </button>
                                <button type="button" class="btn py-1 px-2 btn-primary" data-method="rotate"
                                        data-option="45" title="Rotate Right">
                                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title=""
                                          data-original-title="右旋转45°">
                                      <span class="material-icons align-text-bottom md-18">rotate_right</span>
                                    </span>
                                </button>
                            </div>
                            <div class="btn-group mb-1">
                                <button type="button" class="btn py-1 px-2 btn-primary" data-method="scaleX"
                                        data-option="-1" title="Flip Horizontal">
                                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title=""
                                          data-original-title="水平翻转">
                                      <span class="material-icons align-text-bottom md-18">flip</span>
                                    </span>
                                </button>
                                <button type="button" class="btn py-1 px-2 btn-primary" data-method="scaleY"
                                        data-option="-1" title="Flip Vertical">
                                    <span class="docs-tooltip" data-toggle="tooltip" data-animation="false" title=""
                                          data-original-title="垂直翻转">
                                     <span class="material-icons align-text-bottom md-18"
                                           style="transform: rotate(90deg)">flip</span>
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="btnUploadImg">保存</button>
            </div>
        </div>
    </div>
</div>
<th:block th:replace="fragments/top :: adminPublic('添加商品','发布商品',~{::#content},~{})">
    <div class="content" id="content">
        <div class="row">
            <div class="col-lg-8 col-xl-5">
                <div class="card">
                    <div class="loader-wrapper incomponent" id="loaderDiv">
                        <div class="spinner">
                            <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                                <circle class="length" fill="none" stroke-width="6" stroke-linecap="round" cx="33"
                                        cy="33" r="28"></circle>
                            </svg>
                            <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                                <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33"
                                        r="28"></circle>
                            </svg>
                            <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                                <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33"
                                        r="28"></circle>
                            </svg>
                            <svg viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                                <circle fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33"
                                        r="28"></circle>
                            </svg>
                        </div>
                    </div>
                    <div class="card-header py-3">
                        <div class="media align-items-center mb-0">
                            <div class="media-body">
                                <h6 class="m-0 weight-400">商品资料</h6>
                            </div>

                        </div>

                    </div>

                    <div class="card-body">
                        <form id="form" action="/admin/goods/add" method="post">
                            <!--<div class="alert alert-danger" th:if="${msg != null}">-->
                            <!--<strong>提示:</strong><span th:text="${msg}"></span>-->
                            <!--</div>-->
                            <div class="form-group">
                                <label for="name">商品名称</label>
                                <input type="text" class="form-control" id="name" name="name"
                                       data-fieldname="商品名称"
                                       placeholder="请输入商品的名称(必填)">
                            </div>
                            <div class="form-group">
                                <label for="price">商品价格(￥)</label>
                                <input type="number" class="form-control" min="0" id="price" name="price"
                                       data-fieldname="商品价格"
                                       placeholder="商品价格(必填)">
                            </div>
                            <div class="form-group">
                                <label style="margin-top: 50px;">商品图片</label>
                                <div class="form-row">
                                    <div class="col-6">
                                        <button type="button" data-toggle="modal" data-target="#largeModal"
                                                class="btn btn-warning text-white btn-block" style="margin-top: 40px;">
                                            添加
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <img id="logoPriew" src="/img/admin/logo2.png"
                                             style="width: 100px;margin-left: 60px;">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="description">商品描述</label>
                                <textarea class="form-control" id="description" name="description"
                                          rows="6" placeholder="请输入对项目的描述"></textarea>
                            </div>
                            <input type="hidden" name="token" th:value="${token}">
                            <input type="hidden" name="imgBase" id="imgBase">
                            <button type="submit" id="sub" class="btn btn-block btn-primary btn-lg">发布商品</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>
<th:block th:replace="fragments/js :: managePublic(~{})"></th:block>
<script type="text/javascript" src="/js/validate/jquery.validate.js"></script>
<script type="text/javascript" src="/js/validate/localization/messages_zh_layer.js"></script>
<script type="text/javascript" src="/js/cropper/cropperjs/cropper.min.js"></script>
<script type="text/javascript" src="/js/cropper/jquery-cropper/jquery-cropper.min.js"></script>
<script src="/js/jquery.animate-colors-min.js"></script>
<script src="/js/myPages/myPages.js" type="text/javascript"></script>
<script>

    $(function () {

        $("#form").validate({
            submitHandler: function (form) {
                var name = $("#name").val();
                if (!name.length > 0) {
                    layer.msg("请输入商品名称");
                    return;
                }
                var price = $("#price").val();
                if (price < 0) {
                    $("#price").val(1)
                    layer.msg("请输入商品价格");
                    return;
                }
                var img = $("#imgBase").val();
                if (img == null || img.length == 0) {
                    layer.msg("商品图片不能为空")
                    return;
                }
                layer.confirm('确认添加商品？', {
                    btn: ['确认', '取消'] //按钮
                }, function () {
                    form.submit();
                });
            }
        });


        $("#btnUploadImg").click(function () {
            var canvas = $('#imgFile').cropper('getCroppedCanvas',{fillColor:"#fff"});
            var base64 = canvas.toDataURL('image/jpeg');
            dealImage(base64, 500, 100, function (imgBase64) {
                $("#logoPriew").attr("src", imgBase64);
                $("#imgBase").val(imgBase64)
                $("#largeModal").modal("hide");
            })
        })

        var cropperOptions = {
            aspectRatio: 1,
            viewMode: 1,
            preview: "#preview",
            crop: function (event) {

            }
        }
        var uploadedImageURL;

        $('.custom-file-input').on('change', function () {
            var fileName = $(this).val();
            if (fileName == null || fileName == '') {
                return;
            }

            $(this).next(".custom-file-label").text(fileName)
            var files = $(this).prop("files")
            if (files && files.length) {
                var file = files[0];
                if (/^image\/\w+$/.test(file.type)) {
                    var $image = $('#imgFile');
                    $image.css("padding-bottom", "")
                    if (uploadedImageURL) {
                        URL.revokeObjectURL(uploadedImageURL);
                        $image.cropper("destroy");
                    }
                    uploadedImageURL = URL.createObjectURL(file);
                    $image.attr("src", uploadedImageURL);
                    $image.cropper(cropperOptions);
                } else {
                    layer.msg('请选择一个图像文件！');
                }
            }
        })


        // Methods
        $('.docs-buttons').on('click', '[data-method]', function () {
            $image = $("#imgFile")
            var $this = $(this);
            var data = $this.data();
            var cropper = $image.data('cropper');
            var cropped;
            var $target;
            var result;

            if ($this.prop('disabled') || $this.hasClass('disabled')) {
                return;
            }

            if (cropper && data.method) {
                data = $.extend({}, data); // Clone a new one

                if (typeof data.target !== 'undefined') {
                    $target = $(data.target);

                    if (typeof data.option === 'undefined') {
                        try {
                            data.option = JSON.parse($target.val());
                        } catch (e) {
                            console.log(e.message);
                        }
                    }
                }

                cropped = cropper.cropped;

                result = $image.cropper(data.method, data.option, data.secondOption);

                switch (data.method) {
                    case 'rotate':
                        if (cropped && options.viewMode > 0) {
                            $image.cropper('crop');
                        }
                        break;

                    case 'scaleX':
                    case 'scaleY':
                        $(this).data('option', -data.option);
                        break;

                    case 'getCroppedCanvas':
                        if (result) {
                            // Bootstrap's Modal
                            $('#getCroppedCanvasModal').modal().find('.modal-body').html(result);

                            if (!$download.hasClass('disabled')) {
                                download.download = uploadedImageName;
                                $download.attr('href', result.toDataURL(uploadedImageType));
                            }
                        }

                        break;

                    case 'destroy':
                        if (uploadedImageURL) {
                            URL.revokeObjectURL(uploadedImageURL);
                            uploadedImageURL = '';
                            $image.attr('src', originalImageURL);
                        }

                        break;
                }

                if ($.isPlainObject(result) && $target) {
                    try {
                        $target.val(JSON.stringify(result));
                    } catch (e) {
                        console.log(e.message);
                    }
                }

            } else {
                layer.msg("请先选择图片");
            }
        });

    })

</script>
</body>
</html>
